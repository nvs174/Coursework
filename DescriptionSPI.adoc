:stem:
== Подключение SPI

.Настройка SPI интерфейса
image::picter2/7.png[]

.SPI Write
image::picter2/8.png[]

.SPI Read
image::picter2/9.png[]


.Конфигурация SPI2
image::picter2/10.jpeg[]


.Конфигурация SPI на датчике
image::picter2/11.png[]


.Подключение датчика к отладочной плате
image::picter2/12.png[]

.VCC, GND
image::picter2/13.png[]

== Настройка SPI2
[source, cpp]
----
  RCC::AHB1ENR::GPIOBEN::Enable::Set();
  RCC::APB1ENR::SPI2EN::Enable::Set();
  SPI2::CR1::MSTR::Master::Set();  
  SPI2::CR1::RXONLY::FullDuplex::Set(); 
  SPI2::CR1::DFF::Data8bit::Set();
  SPI2::CR1::CPOL::High::Set(); // 1
  SPI2::CR1::CPHA::Phase2edge::Set(); // 1
  SPI2::CR1::SSM::NssSoftwareEnable::Set(); // раз NssSoftwareEnable, то требуется самостоятельно дергать линию NSS
  SPI2::CR1::BR::PclockDiv2::Set(); // делитель
  SPI2::CR1::LSBFIRST::MsbFisrt::Set(); // формат кадра
  SPI2::CR2::FRF::MotorolaMode::Set(); // 0
  SPI2::CR1::CRCEN::CrcCalcDisable::Set(); // 0
  SPI2::CR1::SPE::Enable::Set();

  GPIOB::MODER::MODER12::Output::Set();
  GPIOB::ODR::ODR12::High::Set(); // логическая 1 на линии NSS
----

== Функция WriteByte
[source, cpp]
----
void WriteByte(uint8_t reg, uint8_t value) 
  {
    uint8_t tx[1]={0};
    uint8_t rx[1] = {0};
    tx[0] = reg | 0x7F; // Bit RW = 0 (Write)
    rx[0] = value;
    GPIOB::ODR::ODR12::Low::Set();
    SPI2::DR::Write(tx[0]);
    SPI2::DR::Write(rx[0]);
    while(!SPI2::SR::BSY::NotBusy::IsSet()) {}
    GPIOB::ODR::ODR12::High::Set();
  }
----

== Функция ReadByte
[source, cpp]
----
uint8_t ReadByte(uint8_t reg)
  {
    uint8_t tx[1] = {0};
    uint8_t rx[1] = {0};
    tx[0]= reg | 0x80; // Bit RW = 1 (Read)
    GPIOB::ODR::ODR12::Low::Set();
    SPI2::DR::Write(tx[0]);
    rx[0] = SPI2::DR::Get();
    while(!SPI2::SR::BSY::NotBusy::IsSet()) {}
    GPIOB::ODR::ODR12::High::Set();
    return static_cast<std::uint8_t> (rx[0]);
  }
----

== Функция ReadByte
[source, cpp]
----
 void ReadWord(uint8_t reg, int16_t *value)
  {
    uint8_t tx[1] = {0};
    int16_t rx[1] = {0};
    tx[0]= reg | 0x80; // Bit RW = 1 (Read)
    GPIOB::ODR::ODR12::Low::Set();
    SPI2::DR::Write(tx[0]);
    rx[0] = SPI2::DR::Get();
    while(!SPI2::SR::BSY::NotBusy::IsSet()) {}
    GPIOB::ODR::ODR12::High::Set();
    *value = rx[0];
  }
----

