
:stem:
== Окружение программы
[#img-image1,link=https://sun9-46.userapi.com/impg/qEq2ttn5v7UkvSyMC6MZx-FuLBFYFAFBHQ0G3w/kPoDd-BhFOM.jpg?size=1563x387&quality=96&sign=f365ade28893cc7ee24a1fef86affa4b&type=album] 
image::image1.jpg[]
.Параметры датчика 
|===
|Наименование | Описание

|BME280| Высокоточный метеодатчик, измеряющий такие параметры микроклимата как температура, влажность и атмосферное давление. В зависимости от модуля может подключаться к I2C и SPI шинами микроконтроллера и работать от 3-5V, если на плате есть стабилизатор, или 3V, если его нет.

|STM32|  это отладочная плата, которая позволит изучить возможности микроконтроллера STM32F411RET6 на базе ядра Cortex-M4.
|BlueTooth Bee HC-06| Беспроводной модуль для приема/передачи данных по протоколу Bluetooth. Особенности: - Поддерживает работу с любым USB Bluetooth адаптером; - Скорость передачи данных: 9600 бит/сек; - Встроенная антенна; - Радиус действия до 10 метров.


|===

== BME280
:table-caption!:

.Параметры датчика
|link:https://kurl.ru/kxTMB[], с 26, 27, 29, 30.|
|===
|Измеряемые физические величины | Система единиц |Регистры, где находятся необработанные выходные данные|Регистры, которые устанавливают параметры сбора данных| объем данных, бит

| Давление | паскаль | 0xF7 - 0xF9 | 0xF4 | 20 
| Температура | градусы цельсия | 0xFA - 0xFC | 0xF4 | 20 
| Влажность | % | 0xFD - 0xFE | 0xF2 | 16 

|===

//* Так как давление измеряется в паскалях, то требуется выполнить перевод в миллиметры ртутного столба:

//.. 1 па = 0,007501 мм.рт.ст

//.. Следовательно итоговое значение давления требуется умножить на 0,007501

* Точка росы - рассчитываемый параметр, для этого воспользуемся формулой:

stem:[Tp = ((b * y(T,Q)) / (a - y(T,Q)) )] +
гдe T — температура в °C +
Q - относительная влажность в объёмных долях +
a = 17,27 +
b = 237,7 °C +
stem:[y(T,Q) = (a * T) / (b + T ) + ln Q]

* Период измерения физических вилечин составляет 100 мс.

* В BME280 предусмотрен БИХ-фильтр, для более точных измерений он будет включен.

* Общение с датчиком осуществляться по интерфейсу SPI4 (SPI_CR4).


.Регистры необходимые для настройки датчика
|===
|Регистр | Описание | Страница в документации link:https://kurl.ru/kxTMB[]

| 0x76| Адрес BME280 | 32

| 0xD0| ID регистр BME280 | 26

| 0x60| Информация, читаемая от BME280 в ID регистре | 26

| 0xE0| Регистр для перезагрузки BME280 | 26

| 0xB6| Значение, записываемое в регистр для перезагрузки BME280 | 26

| 0xF3| Регистр статуса BME280 | 26

| 0x88, 0x8A, 0x8C| Регистр, откуда читаем калибровочное значение температуры | 22, 23

| 0xA1, 0xE1, 0xE3, 0xE4, 0xE5, 0xE7| Регистр, откуда читаем калибровочное значение влажности | 22, 23

| 0x8E, 0x90, 0x92, 0x94, 0x96, 0x98, 0x9A, 0x9C, 0x9E| Регистр, откуда читаем калибровочное значение давления |22, 23

| 0xF5| Регистр конфигурации BME280, задаём время ожидания, значение постоянной времени
фильтра BME280 | 28
|===

* Все данные передаются младшим байтом в перед, по этому будет необходима функция перестановки байтов

* Выбор интерфейса осуществляется автоматически на основе статуса CSB (выбор чипа). Если CSB подключен к VDDIO, интерфейс I²C активен. Если CSB отключен, активируется интерфейс SPI.


== плата Accessories Shield & BlueTooth Bee HC-06 

.Подключение линий данных
|===
| Наименование линий на STM| Пин на плате STM| Наименование линий на BlueTooth Bee HC-06  

| RX_STM | PD5 | TX_HC06 

| TX_STM | PD6 | RX_HC06
|===


== Настройка SPI4 STM32F411RE

.Конфигурация линий SPI4
|===
| Пин| Наименование линии  

| PA1 | NSS

| PE12 |SCK

| PE13 | MISO

| PE14 | MOSI
|===

|===
| Биты отправляемы по MOSI| Описание  

| 0x77 | команда на запись
| 0xF7 | команда на чтение
|===


.Регистры необходимые для настройки SPI4
|===
| Бит| Описание | Состояния  
| DFF | формат кадра данных | 0 -для передачи/приема выбран 8-битный формат кадра данных.

1 - для передачи/приема выбран 16-битный формат кадра данных.

| LSBFIRST | формат кадра | 0 - старший бит передается первым.

1 -  младший бит передается первым.


|SPE | включение SPI| 0 - Периферийное устройство отключено.

1 -  Периферийное устройство включено.

| BR[2:0] | контроль скорости передачи данных |

000 - fPCLK/2.

001 - fPCLK/4.

010 - fPCLK/8.

011 - fPCLK/16.

100 - fPCLK/32.

101 - fPCLK/64.

110 - fPCLK/128.

111 - fPCLK/256.

| MSTR | выбор ведущего устройства | 0 - Конфигурация подчиненного устройства.

1 - Основная конфигурация.
|===
Страница в документации link:https://kurl.ru/cWNNf[], с 601

== Настройка USART2 STM32F411RE

. Подключить USART к источнику тактирования – устанавливаем бит USART2EN в регистре APB1ENR.​

. Настроить порты, на альтернативную функцию нужного модуля USART2​.

. Настроить формат передачи байт, с помощью регистра CR1 и CR2​.

. Задать скорость передачи с помощью регистра BRR

. Включить сам модуль USART2 битом UE в регистре CR1​.

. Разрешить глобальное прерывание для нужного USART, в регистре ISER[1] модуля NVIC, настроив на время равное 1 с​.

. Настроить порты PORT PD5 как TX, Port PD6 как RX на альтернативную функцию работы с UART в режим Push-Pull(двухтактный выход) + Pull Up(подтяжка к 1)​

Настроить USART2 на скорость 9600 бит/c, 1 стоп бит, 1 старт бит, без проверки четности, режим дискретизации 1/16, 8 бит данных.
