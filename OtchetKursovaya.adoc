== Окружение программы
[#img-image1,link=https://sun9-46.userapi.com/impg/qEq2ttn5v7UkvSyMC6MZx-FuLBFYFAFBHQ0G3w/kPoDd-BhFOM.jpg?size=1563x387&quality=96&sign=f365ade28893cc7ee24a1fef86affa4b&type=album] 
image::image1.jpg[]

== BME280 

. Датчик BME280 используется для измерения давления, влажности и температуры.

. Период измерения составляет 100 мс.

. В BME280 предусмотрен БИХ-фильтр, для более точных измерений он будет включен.

. Общение с датчиком осуществляться по интерфейсу SPI4 (SPI_CR4) находится на линиях:

.. PA1 - NSS;

.. PE12 - SCK;

.. PE13 - MISO;

.. PE14 - MOSI.

. Байты отправляемы по MOSI: 

.. Байт (0x77) - команда на запись;

.. Байт (0xF7) - команда на чтение.

. BME280 измерение температуры:

.. Температура измеряется в градусах цельсия;

.. Объем данных температуры равен 20 бит;

.. "ctrl_meas" (0xF4) - Регистр которые устанавливает параметры сбора данных температуры;

.. Регистры (0xFA…0xFC) - Содержат необработанные выходные данные измерения температуры.

. BME280 измерение давления:

.. Давление измеряется в паскалях, требуется перевести паскали в миллиметры ртутного столба, 1 па = 133.321995 миллиметрам ртутного столба, следовательно итоговое значение давления требуется поделить на 133.321995;

.. Объем данных давления равен 20 бит;

.. "ctrl_meas" (0xF4) - Регистр которые устанавливает параметры сбора данных давления;

.. Регистры (0xF7…0xF9) - Содержат необработанные выходные данные измерения давления.

. BME280 измерение влажности:

.. Влажность измеряется в %;

.. Объем данных влажности равен 16 бит;

.. "ctrl_hum" (0xF2) - Регистр которые устанавливает параметры сбора данных влажности.

.. Регистры (0xFD…0xFE) - Содержат необработанные выходные данные измерения влажности.

. Точка росы - рассчитываемый параметр, для этого потребуется:

.. Показания температуры - T;

.. Показания влажности - φ (фи).

[#img-image2,link=https://sun9-11.userapi.com/impg/pCUxks5X5LeHlpO3W7DJpCHkmO2y6zha9zZy5A/J4KLfDaMJBA.jpg?size=237x94&quality=96&sign=0a3c054e23eaec35c202aa9bd07c501b&type=album] 
image::image2.jpg[]

. Для настройки BME280 потребуется следующие регистры:

.. регистр (0x76) - Адрес BME280;

.. регистр (0xD0) - ID регистр BME280;

.. регистр (0x60) - Информация, читаемая от BME280 в ID регистре; 

.. регистр (0xE0) - Регистр для перезагрузки BME280; 

.. регистр (0xB6) - Значение, записываемое в регистр для перезагрузки BME280;

.. регистр (0XF3) - Регистр статуса BME280; 

.. регистр (0X01) - Значение из регистра статуса при окончании измерения BME280; 

.. регистры (0x88, 0x8A, 0x8C) - Регистр, откуда читаем калибровочное значение температуры;

.. регистры (0xA1, 0xE1, 0xE3, 0xE4, 0xE5, 0xE7) - Регистр, откуда читаем калибровочное значение влажности;

.. регистры (0x8E, 0x90, 0x92, 0x94, 0x96, 0x98, 0x9A, 0x9C, 0x9E) - Регистр, откуда читаем калибровочное значение давления;

.. регистр (0xF5) - Регистр конфигурации BME280, задаём время ожидания, значение постоянной времени
фильтра BME280 

. Все данные передаются младшим байтом в перед, по этому будет необходима функция перестановки байтов

. Выбор интерфейса SPI выполняется с помощью условия - выбор интерфейса осуществляется автоматически на основе статуса CSB (выбор чипа). Если CSB подключен к VDDIO, интерфейс I²C активен. Если CSB отключен, активируется интерфейс SPI.


== плата Accessories Shield & BlueTooth Bee HC-06 

. Подключаем RX_STM - TX_HC

. Подключаем TX_STM - RX_HC


== Настройка SPI4 STM32F411RE

. Бит 13 CRCEN: включение аппаратного расчета CRC:
.. 0: вычисление CRC отключено.

.. 1: вычисление CRC включено

. Бит 11 DFF: формат кадра данных:

.. 0: для передачи/приема выбран 8-битный формат кадра данных.

.. 1: для передачи/приема выбран 16-битный формат кадра данных.

.. Примечание. Этот бит следует записывать только в том случае, если SPI отключен (SPE = «0») для правильной работы.

. Бит 9 SSM: программное управление ведомыми устройствами:

.. Когда бит SSM установлен, входной сигнал вывода NSS заменяется значением бита SSI.

.. 0: Программное управление ведомыми устройствами отключено.

.. 1: Программное управление ведомыми устройствами включено.

.. Примечание. Этот бит не используется в режиме I2S и режиме SPI TI.

. Бит 7 LSBFIRST: формат кадра:

.. 0: старший бит передается первым

.. 1: младший бит передается первым
.. Примечание. Этот бит не следует изменять во время обмена данными. Он не используется в режиме I2S и режиме SPI TI.

. Бит 6 SPE: включение SPI:

.. 0: Периферийное устройство отключено.

.. 1: Периферийное устройство включено

. Биты 5:3 BR[2:0]: контроль скорости передачи данных:

.. 000: fPCLK/2

.. 001: fPCLK/4

.. 010: fPCLK/8

.. 011: fPCLK/16

.. 100: fPCLK/32

.. 101: fPCLK/64

.. 110: fPCLK/128

.. 111: fPCLK/256

. Бит 2 MSTR: выбор ведущего устройства:

.. 0: Конфигурация подчиненного устройства

.. 1: Основная конфигурация

. Бит 1 CPOL: полярность тактового сигнала:

.. 0: CK до 0 в режиме ожидания

.. 1: CK в 1 в режиме ожидания

. Бит 0 CPHA: фаза тактирования:

.. 0: первый переход тактовой частоты является первым фронтом захвата данных.

.. 1: Второй тактовый переход является первым фронтом захвата данных.

== Настройка USART2 STM32F411RE

. Подключить USART к источнику тактирования – устанавливаем бит USART2EN в регистре APB1ENR.​

. Настроить порты, на альтернативную функцию нужного модуля USART2​.

. Настроить формат передачи байт, с помощью регистра CR1 и CR2​.

. Задать скорость передачи с помощью регистра BRR - ?​

. Включить сам модуль USART2 битом UE в регистре CR1​.

. Разрешить глобальное прерывание для нужного USART, в регистре ISER[1] модуля NVIC, настроив на время равное 1 с​.

. Настроить порты PORT PD5 как TX, Port PD6 как RX на альтернативную функцию работы с UART в режим Push-Pull(двухтактный выход) + Pull Up(подтяжка к 1)​

Настроить USART2 на скорость 9600 бит/c, 1 стоп бит, 1 старт бит, без проверки четности, режим дискретизации 1/16, 8 бит данных.


== Вопросы

. Чип селект (NSS) выставить как (input signal ) или (output signal) ?

. Нужен CRC  ?

. 8-битный или 16-битный формат кадра данных SPI ?

. Младшим байтом или старшим байтов получать данные по spi (данные с BME280 передаются младшим байтом в перед) ?

. Какую выбрать скорость передачи данных по SPI ?

. Скорость работы USART2 ?

. Количество бит данных USART2

. Какие имеет настройки плата плата Accessories Shield & BlueTooth Bee HC-06  - ее как то настраивать надо или просто подается питание и линии RX, TX?