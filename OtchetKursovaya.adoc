= Окружение программы

:stem:
== Окружение программы
[#img-image1,link=https://sun9-46.userapi.com/impg/qEq2ttn5v7UkvSyMC6MZx-FuLBFYFAFBHQ0G3w/kPoDd-BhFOM.jpg?size=1563x387&quality=96&sign=f365ade28893cc7ee24a1fef86affa4b&type=album] 
image::image1.jpg[]

== BME280
:table-caption!:

.Параметры датчика
|===
|Измеряемые физические величины | Система единиц |Регистры, где находятся необработанные выходные данные|Регистры, которые устанавливают параметры сбора данных| объем данных, бит

| Давление | паскаль | 0xF7 - 0xF9 | 0xF4 | 20 
| Температура | градусы цельсия | 0xFA - 0xFC | 0xF4 | 20 
| Влажность | % | 0xFD - 0xFE | 0xF2 | 16 

|===

* Так как давление измеряется в паскалях, то требуется выполнить перевод в миллиметры ртутного столба:

.. 1 па = 0,007501 мм.рт.ст

.. Следовательно итоговое значение давления требуется умножить на 0,007501

* Точка росы - рассчитываемый параметр, для этого воспользуемся формулой:

stem:[Tp = ((b * y(T,Q)) / (a - y(T,Q)) )] +
гдe T — температура в °C +
Q - относительная влажность в объёмных долях +
a = 17,27 +
b = 237,7 °C +
stem:[y(T,Q) = (a * T) / (b + T ) + ln Q]

* Период измерения физических вилечин составляет 100 мс.

* В BME280 предусмотрен БИХ-фильтр, для более точных измерений он будет включен.

* Общение с датчиком осуществляться по интерфейсу SPI4 (SPI_CR4).

.Регистры необходимые для настройки датчика
|===
|Регистр | Описание

| 0x76| Адрес BME280;

| 0xD0| ID регистр BME280;

| 0x60| Информация, читаемая от BME280 в ID регистре; 

| 0xE0| Регистр для перезагрузки BME280; 

| 0xB6| Значение, записываемое в регистр для перезагрузки BME280;

| 0XF3| Регистр статуса BME280; 

| 0X01| Значение из регистра статуса при окончании измерения BME280; 

| 0x88, 0x8A, 0x8C| Регистр, откуда читаем калибровочное значение температуры;

| 0xA1, 0xE1, 0xE3, 0xE4, 0xE5, 0xE7| Регистр, откуда читаем калибровочное значение влажности;

| 0x8E, 0x90, 0x92, 0x94, 0x96, 0x98, 0x9A, 0x9C, 0x9E| Регистр, откуда читаем калибровочное значение давления;

| 0xF5| Регистр конфигурации BME280, задаём время ожидания, значение постоянной времени
фильтра BME280 

|===

 * Все данные передаются младшим байтом в перед, по этому будет необходима функция перестановки байтов

* Выбор интерфейса осуществляется автоматически на основе статуса CSB (выбор чипа). Если CSB подключен к VDDIO, интерфейс I²C активен. Если CSB отключен, активируется интерфейс SPI.


== плата Accessories Shield & BlueTooth Bee HC-06 

.Подключение линий данных
|===
| Наименование линий на STM| Пин на плате STM| Наименование линий на BlueTooth Bee HC-06  


| RX_STM | PD5 | TX_HC06 

| TX_STM | PD6 | RX_HC06

|===


== Настройка SPI4 STM32F411RE


//. Общение с датчиком осуществляться по интерфейсу SPI4 (SPI_CR4) находится на линиях:

//.. PA1 - NSS;

//.. PE12 - SCK;

//.. PE13 - MISO;

//.. PE14 - MOSI.

//. Байты отправляемы по MOSI: 

//.. Байт (0x77) - команда на запись;

//.. Байт (0xF7) - команда на чтение.



.Подключение линий данных
|===
| Наименование линий на STM| Пин на плате STM| Наименование линий на BlueTooth Bee HC-06  


| RX_STM | PD5 | TX_HC06 

| TX_STM | PD6 | RX_HC06

|===




. Бит 13 CRCEN: включение аппаратного расчета CRC:
.. 0: вычисление CRC отключено.

.. 1: вычисление CRC включено

. Бит 11 DFF: формат кадра данных:

.. 0: для передачи/приема выбран 8-битный формат кадра данных.

.. 1: для передачи/приема выбран 16-битный формат кадра данных.

.. Примечание. Этот бит следует записывать только в том случае, если SPI отключен (SPE = «0») для правильной работы.

. Бит 9 SSM: программное управление ведомыми устройствами:

.. Когда бит SSM установлен, входной сигнал вывода NSS заменяется значением бита SSI.

.. 0: Программное управление ведомыми устройствами отключено.

.. 1: Программное управление ведомыми устройствами включено.

.. Примечание. Этот бит не используется в режиме I2S и режиме SPI TI.

. Бит 7 LSBFIRST: формат кадра:

.. 0: старший бит передается первым

.. 1: младший бит передается первым
.. Примечание. Этот бит не следует изменять во время обмена данными. Он не используется в режиме I2S и режиме SPI TI.

. Бит 6 SPE: включение SPI:

.. 0: Периферийное устройство отключено.

.. 1: Периферийное устройство включено

. Биты 5:3 BR[2:0]: контроль скорости передачи данных:

.. 000: fPCLK/2

.. 001: fPCLK/4

.. 010: fPCLK/8

.. 011: fPCLK/16

.. 100: fPCLK/32

.. 101: fPCLK/64

.. 110: fPCLK/128

.. 111: fPCLK/256

. Бит 2 MSTR: выбор ведущего устройства:

.. 0: Конфигурация подчиненного устройства

.. 1: Основная конфигурация

. Бит 1 CPOL: полярность тактового сигнала:

.. 0: CK до 0 в режиме ожидания

.. 1: CK в 1 в режиме ожидания

. Бит 0 CPHA: фаза тактирования:

.. 0: первый переход тактовой частоты является первым фронтом захвата данных.

.. 1: Второй тактовый переход является первым фронтом захвата данных.

== Настройка USART2 STM32F411RE

. Подключить USART к источнику тактирования – устанавливаем бит USART2EN в регистре APB1ENR.​

. Настроить порты, на альтернативную функцию нужного модуля USART2​.

. Настроить формат передачи байт, с помощью регистра CR1 и CR2​.

. Задать скорость передачи с помощью регистра BRR - ?​

. Включить сам модуль USART2 битом UE в регистре CR1​.

. Разрешить глобальное прерывание для нужного USART, в регистре ISER[1] модуля NVIC, настроив на время равное 1 с​.

. Настроить порты PORT PD5 как TX, Port PD6 как RX на альтернативную функцию работы с UART в режим Push-Pull(двухтактный выход) + Pull Up(подтяжка к 1)​

Настроить USART2 на скорость 9600 бит/c, 1 стоп бит, 1 старт бит, без проверки четности, режим дискретизации 1/16, 8 бит данных.


== Вопросы

. Чип селект (NSS) выставить как (input signal ) или (output signal) ?

. Нужен CRC  ?

. 8-битный или 16-битный формат кадра данных SPI ?


. Младшим байтом или старшим байтов получать данные по spi (данные с BME280 передаются младшим байтом в перед) ?

. Как выбрать скорость передачи данных по SPI ?

. Как выбирается интерфейс SPI на BME280 ?

. Как выбрать скорость работы USART2 ?

. Количество бит данных USART2 ?

. Какие имеет настройки плата плата Accessories Shield & BlueTooth Bee HC-06  - ее как то настраивать надо или просто подается питание и линии RX, TX ?

. Для задержки в 0,1 с и 1 с потребуется использовать таймеры ?
